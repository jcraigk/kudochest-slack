#!/usr/bin/env ruby
require 'net/ssh'
require 'dotenv'
require 'colorize'

Dotenv.load

IMAGE_NAME = 'kudochest/biz-kudochest:edge'
SUDO_PASSWORD = ENV.fetch('SUDO_PASSWORD')
DOCKER_PASSWORD = ENV.fetch('DOCKER_PASSWORD')
ROLES = ENV.fetch('ROLES', 'worker,web')
COMMANDS = [
  # "echo #{SUDO_PASSWORD} | sudo -S dokku registry:login docker.io kudochest #{DOCKER_PASSWORD}",
  "echo #{SUDO_PASSWORD} | sudo -S docker rmi #{IMAGE_NAME}",
  "echo #{SUDO_PASSWORD} | sudo -S dokku git:from-image kudochest #{IMAGE_NAME}",
  "echo #{SUDO_PASSWORD} | sudo -S dokku ps:rebuild kudochest",
]
SSH_PRIVATE_KEY_PATH = '/Users/jcraigk/.ssh/id_rsa'
SSH_USERNAME = 'jcraigk'

def execute_commands_on_ip(ip_address, commands)
  Net::SSH.start(ip_address, SSH_USERNAME, keys: [SSH_PRIVATE_KEY_PATH]) do |ssh|
    commands.each do |command|
      result = ssh.exec!(command)
      # puts command.yellow
      puts result
      puts ("-" * 50).light_blue
    end
  end
end

ROLES.split(',').each do |role|
  ENV.fetch("#{role.upcase}_BOXES").split(',').each do |ip_address|
    puts "START: #{ip_address}".light_blue
    execute_commands_on_ip(ip_address, COMMANDS)
    puts "COMPLETE: #{ip_address}".light_blue
    puts ("=" * 50).light_blue
  end
end

